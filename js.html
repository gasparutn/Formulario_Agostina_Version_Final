<script>
const APP_URL = GLOBAL_APP_URL;
// (MODIFICADO) Lee la nueva variable global de Index.html
const PAGO_TOTAL_MP_VISIBLE = GLOBAL_PAGO_TOTAL_MP_VISIBLE;
const CACHE_KEY = 'formDataCache';
let GLOBAL_EDIT_DATA = {}; // (NUEVO) Almacena los datos del usuario para editar

// =========================================================
// DEFINICIONES DE FUNCIONES
// =========================================================

/**
 * (CORREGIDO) Handler para fallo de PASO 1 (Registro)
 */
function handleRegistroFailure(error) {
  document.getElementById('submit-button').disabled = false;
  document.getElementById('loader-registro').style.display = 'none';
  const errorMessage = error.message || 'Ocurrió un error desconocido al registrar.';
  document.getElementById('status-registro').innerHTML = `<div class="mensaje error"><strong>Error al Registrar:</strong> ${errorMessage}</div>`;
}

/**
 * (NUEVO) Handler para éxito de PASO 1. Llama a PASO 2.
 */
function handlePaso1Success(response) {
  if (response.status === 'OK_REGISTRO') {
    // Pasa al Paso 2
    document.getElementById('loader-registro').querySelector('p').textContent = 'Finalizando registro...';
    google.script.run
      .withSuccessHandler(handlePagoSuccess) // Handler de éxito de Paso 2
      .withFailureHandler(handlePagoFailure) // Handler de fallo de Paso 2
      .paso2_crearPagoYEmail(response.datos, response.numeroDeTurno, response.hermanosRegistrados);
  } else {
    // Si 'paso1_registrarRegistro' devolvió un error lógico (DNI duplicado, etc.)
    handleRegistroFailure(response); // Usa el handler de fallo de registro
  }
}

/**
 * (MODIFICADO) Handler para éxito de PASO 2 (Creación de Pago)
 * Eliminada la lógica de OK_PAGO (Mercado Pago).
 */
function handlePagoSuccess(response) {
  document.getElementById('registroForm').style.display = 'none';
  document.getElementById('loader-registro').style.display = 'none';
  const statusDiv = document.getElementById('status-registro');

  const dniJustRegistered = response.dniRegistrado;
  let listFromCache = JSON.parse(localStorage.getItem('pendingSiblings') || 'null');
  let listToDisplay = [];
  let isFinalRegistration = false;

  if (listFromCache) {
    listToDisplay = listFromCache.filter(h => h.dni !== dniJustRegistered);
    if (listToDisplay.length === 0) {
      isFinalRegistration = true;
    }
  } else if (response.hermanos && response.hermanos.length > 0) {
    listToDisplay = response.hermanos;
  }

  let htmlHermanos = '';
  if (isFinalRegistration) {
    localStorage.removeItem('pendingSiblings');
    htmlHermanos = `<div class="mensaje exito" style="text-align:center; margin-top: 20px;">¡La familia se ha registrado de forma exitosa!!!.</div>`;
  } else if (listToDisplay.length > 0) {
    localStorage.setItem('pendingSiblings', JSON.stringify(listToDisplay));
    htmlHermanos = `<h3>Hermanos/as Pendientes de Completar:</h3><div class="hermanos-pendientes-container">`;
    listToDisplay.forEach(h => {
      htmlHermanos += `
      <div class="hermano-pendiente-item">
      <span>${h.nombre} ${h.apellido} (DNI: ...${h.dni.slice(-3)})</span>
      <button type="button" class="btn-completar-hermano" data-dni="${h.dni}" data-tipo="${h.tipo}">Completar Datos</button>
      </div>`;
    });
    htmlHermanos += `</div>`;
  } else {
    localStorage.removeItem('pendingSiblings');
  }

  // (MODIFICADO) Solo se espera OK_EFECTIVO o OK_REGISTRO_SIN_LINK (errores)
  if (response && (response.status === 'OK_EFECTIVO' || response.status === 'OK_REGISTRO_SIN_PAGO')) {
    statusDiv.innerHTML = `
    <div class="mensaje exito">${response.message}</div>
    ${htmlHermanos}
    <button type="button" id="btn-volver-form-limpio" class="btn-final-volver" style="margin-top: 20px;">Volver a Iniciar (Formulario Limpio)</button>
    `;

  } else if (response && response.status === 'OK_REGISTRO_SIN_LINK') {
    statusDiv.innerHTML = `<div class="mensaje aviso">${response.message}</div>
    ${htmlHermanos}
    <button type="button" id="btn-volver-form-limpio" class="btn-final-volver" style="margin-top: 20px;">Volver a Iniciar (Formulario Limpio)</button>
    `;

  } else {
    // Error
    const errorMessage = response.message || 'Ocurrió un error desconocido en el paso 2.';
    statusDiv.innerHTML = `<div class="mensaje error"><strong>Error:</strong> ${errorMessage}</div>`;
    document.getElementById('registroForm').style.display = 'block';
    document.getElementById('submit-button').disabled = false;
  }

  document.getElementById('btn-volver-form-limpio').addEventListener('click', function() {
    localStorage.removeItem('pendingSiblings');
    window.top.location.href = APP_URL;
  });

  document.querySelectorAll('.btn-completar-hermano').forEach(btn => {
    btn.addEventListener('click', function() {
      const dni = this.dataset.dni;
      const tipo = this.dataset.tipo;
      localStorage.setItem('autoValidateDNI', dni);
      localStorage.setItem('autoValidateType', tipo);
      window.top.location.href = APP_URL;
    });
  });
}

/**
 * (CORREGIDO) Handler para fallo de PASO 2 (Creación de Pago)
 */
function handlePagoFailure(error) {
  document.getElementById('submit-button').disabled = false;
  document.getElementById('loader-registro').style.display = 'none';
  const errorMessage = error.message || error;
  document.getElementById('status-registro').innerHTML = `<div class="mensaje aviso">
  <strong>¡¡REGISTRO GUARDADO!!</strong><br>
  Pero ocurrió un error al finalizar: ${errorMessage}.
  <br>Por favor, contacte a la administración.
  </div>`;
}


// =========================================================
// --- ¡¡INICIO DE LA CORRECCIÓN!! ---
// Se implementan tus nuevas solicitudes (Edición, limpieza de MP, etc.)
// =========================================================

function handleValidationSuccess(response) {
  document.getElementById('btn-validar').disabled = false;
  document.getElementById('loader-validacion').style.display = 'none';
  const statusDiv = document.getElementById('status-validacion');

  // (NUEVO) Leer la variable B24 que pasamos desde Index.html
  const pagoTotalMPVisible = (response.pagoTotalMPVisible === true);

  // (NUEVO) Guardar datos del usuario para la edición
  if(response.datos) {
    GLOBAL_EDIT_DATA = response.datos;
  }

  if (response.status === 'HERMANO_COMPLETAR') {
    statusDiv.innerHTML = `<div class="mensaje aviso" style="text-align: left;">${response.message}</div>`;
    document.getElementById('esHermanoCompletando').value = "true";
    const seccionHermanos = document.getElementById('seccion-hermanos');
    if (seccionHermanos) seccionHermanos.style.display = 'none';
    iniciarTemporizador(response);

  } else if (response.status === 'OK_PREVENTA' || response.status === 'OK' || response.status === 'OK_NUEVO') {
    document.getElementById('esHermanoCompletando').value = "false";
    const seccionHermanos = document.getElementById('seccion-hermanos');
    if (response.status === 'OK_PREVENTA') {
      if (seccionHermanos) seccionHermanos.style.display = 'none';
    } else {
      if (seccionHermanos) seccionHermanos.style.display = 'block';
    }
    iniciarTemporizador(response);

  } else if (response.status === 'REGISTRO_ENCONTRADO') {

    let html = '';
    const proximaCuotaMsg = response.proximaCuotaPendiente
      ? `<br><strong>Próxima Cuota Pendiente: ${response.proximaCuotaPendiente.replace('C', 'Cuota ')}</strong>.`
      : '';

    if (response.message.includes('PAGADO')) {
      html += `<div class="mensaje exito" style="margin-bottom:10px; text-align:left;"><strong>${response.message}</strong></div>`;
    } else {
      let msgPago = response.message_pago ? `<br>${response.message_pago}` : '';
      html += `<div class="mensaje aviso" style="margin-bottom:10px; text-align:left;"><strong>${response.message}</strong>${msgPago}${proximaCuotaMsg}</div>`;
    }

    if (response.adeudaAptitud === true) {
      html += `
      <div id="aptitud-manual-seccion" style="margin-top: 15px; padding: 10px; border: 1px solid #e67e22; border-radius: 5px; background: #fdf5e6;">
      <h3 style="background-color: #e67e22; color: white; padding: 10px;">¡Atención!</h3>
      <p style="text-align: center; font-weight: bold; color: #e67e22;">Adeuda Certificado de Aptitud Física</p>
      <p>Por favor, suba el certificado para completar la ficha.</p>
      <label for="aptitud-manual-upload" class="file-input-label" style="background-color: #e67e22;">Seleccionar Certificado</label>
      <input type="file" id="aptitud-manual-upload" accept="image/jpeg, image/png, application/pdf">
      <span id="aptitud-manual-name" class="file-name">Ningún archivo seleccionado</span>
      <div id="aptitud-error-msg" class="inline-error"></div> <button type="button" id="btn-submit-aptitud-manual" style="background-color: #e67e22; width: 100%; height:45px">Subir Certificado!!!</button>
      <div class="loader" id="loader-aptitud" style="display: none;"><div class="spinner"></div><p>Subiendo...</p></div>
      </div>`;
    }

    // =========================================================
    // --- (MODIFICADO) Lógica de Comprobantes (Sin MP) ---
    // =========================================================
    if (!response.message.includes('PAGADO') && !response.message.includes('En revisión')) {
      html += `
      <div id="comprobante-manual-seccion" style="margin-top: 15px; border: 1px solid var(--color-principal); padding: 15px; border-radius: 5px;">
      `;

      // (MODIFICADO) Eliminados los botones y errores de Mercado Pago
      html += `<h3>Subir un comprobante (Cuota, Transferencia, etc.):</h3>`;

      // --- INICIO DE MODIFICACIONES DE SELECTOR ---
      html += `
      <label for="tipo-comprobante-select">Seleccione el tipo de comprobante:</label>
      <select id="tipo-comprobante-select">
        <option value="">-- Elija una opción --</option>
        
        <option value="mp_total" style="display: ${pagoTotalMPVisible ? 'block' : 'none'};">a) Comprobante Pago Total (Transferencia/Externo)</option>
        
        <option value="mp_cuotas_group">b) Comprobante Pagos 3 cuotas</option>
        
        <option value="externo">c) Comprobante Externo (Transferencia, etc.)</option>
      </select>

      <div id="cuota-selector-container" style="display: none; margin-top: 10px;">
        <label for="cuota-selector">Seleccione la Cuota a la que corresponde el comprobante:</label>
        <select id="cuota-selector">
          <option value="">-- Seleccione Cuota --</option>
          <option value="mp_cuota_1">b.1) Cuota 1</option>
          <option value="mp_cuota_2">b.2) Cuota 2</option>
          <option value="mp_cuota_3">b.3) Cuota 3</option>
          <option value="mp_cuota_total">b.4) Cancelación total</option>
        </select>
      </div>
      `;
      // --- FIN DE MODIFICACIONES DE SELECTOR ---

      html += `
      <div id="datos-externo-container">
      <label for="externo-nombre-pagador">Nombre y Apellido (del Adulto Pagador):</label>
      <input type="text" id="externo-nombre-pagador" placeholder="Nombre Apellido (Quien paga)">
      <label for="externo-dni-pagador">DNI (del Adulto Pagador):</label>
      <input type="tel" id="externo-dni-pagador" placeholder="DNI (Quien paga)" pattern="[0-9]{8}" inputmode="numeric" maxlength="8" title="El DNI debe tener exactamente 8 dígitos numéricos.">
      </div>

      <div id="upload-file-container">
      <label for="comprobante-manual-upload" class="file-input-label" style="background-color: #7f8c8d;">Seleccionar Archivo para Subir</label>
      <input type="file" id="comprobante-manual-upload" accept="image/jpeg, image/png, application/pdf">
      <div style="display: flex; align-items: center; margin-bottom: 15px;">
      <span id="comprobante-manual-name" class="file-name" style="margin-bottom: 0;">Ningún archivo seleccionado</span>
      <button type="button" id="btn-clear-comprobante" class="btn-remover" style="display:none; margin-top: 0; margin-left: 10px;">X</button>
      </div>
      <div id="comprobante-error-msg" class="inline-error"></div> <button type="button" id="btn-submit-comprobante-manual">Subir Comprobante</button>
      </div>

      </div> `;
    }

    // --- (NUEVO) Sección de Edición de Datos ---
    html += `
    <button type="button" id="btn-editar-info" class="btn-editar" style="margin-top: 20px;">✏️ Editar Información Personal</button>

    <div id="editar-info-seccion" style="display:none;">
    <h3>Editar Información Personal</h3>
    <p>Modifique los datos permitidos y guarde los cambios. Los campos grises no se pueden editar.</p>

    <label for="edit-email">Email (No editable):</label>
    <input type="email" id="edit-email" readonly>

    <label for="edit-adultoResponsable1">Responsable 1: (Nombre y Apellido)</label>
    <input type="text" id="edit-adultoResponsable1">
    <label for="edit-dniResponsable1">DNI Responsable 1:</label>
    <input type="tel" id="edit-dniResponsable1" pattern="[0-9]{8}" inputmode="numeric" maxlength="8">

    <label for="edit-telAreaResp1">Teléfono Responsable 1:</label>
    <div class="grupo-telefono">
    <input type="tel" id="edit-telAreaResp1" class="telefono-area-code" placeholder="Cod. Área">
    <input type="tel" id="edit-telNumResp1" class="telefono-numero" placeholder="Número">
    </div>

    <label for="edit-adultoResponsable2">Responsable 2 (Opcional):</label>
    <input type="text" id="edit-adultoResponsable2">
    <label for="edit-telAreaResp2">Teléfono Responsable 2 (Opcional):</label>
    <div class="grupo-telefono">
    <input type="tel" id="edit-telAreaResp2" class="telefono-area-code" placeholder="Cod. Área">
    <input type="tel" id="edit-telNumResp2" class="telefono-numero" placeholder="Número">
    </div>

    <label style="margin-top: 20px;">Personas autorizadas a retirar: (Mínimo 1)</label>
    <div id="autorizados-container-edit">
    </div>
    <button type="button" id="btn-add-autorizado-edit" class="btn-dinamico">Agregar Autorizado</button>

    <hr style="margin-top: 20px;">

    <label for="edit-certificadoAptitud">Actualizar Certificado de Aptitud Física:</label>
    <label for="edit-certificadoAptitud" class="file-input-label">Seleccionar Nuevo Certificado</label>
    <input type="file" id="edit-certificadoAptitud" accept="image/jpeg, image/png, application/pdf">
    <span id="edit-certificadoAptitudName" class="file-name">Ningún archivo seleccionado</span>
    <div class="loader-archivo" id="loader-certificado-edit"></div>
    <input type="hidden" id="urlCertificadoAptitud-edit">

    <div id="edicion-error-msg" class="inline-error"></div> <div id="edicion-success-msg" class="mensaje exito" style="display:none;"></div>

    <button type="button" id="btn-guardar-edicion" class="btn-guardar">Guardar Cambios</button>
    <button type="button" id="btn-cancelar-edicion" class="btn-cancelar">Cancelar Edición</button>
    </div>
    `;

    // --- Botón Finalizar ---
    html += `<button type="button" id="btn-finalizar-upload" class="btn-final-volver" style="margin-top: 20px;">Finalizar (Volver al Inicio)</button>`;

    statusDiv.innerHTML = html;

    // Listener de Aptitud (solo si se mostró)
    if (response.adeudaAptitud === true) {
      document.getElementById('aptitud-manual-upload').addEventListener('change', function() {
        document.getElementById('aptitud-manual-name').textContent = this.files[0] ? this.files[0].name : 'Ningún archivo seleccionado';
        document.getElementById('aptitud-error-msg').textContent = ''; // Limpiar error
      });
      document.getElementById('btn-submit-aptitud-manual').addEventListener('click', submitAptitudManual);
    }

    // =========================================================
    // --- (MODIFICADO) Listeners (Sin MP, con Edición) ---
    // =========================================================
    if (!response.message.includes('PAGADO') && !response.message.includes('En revisión')) {
      const cuotaSelectorContainer = document.getElementById('cuota-selector-container');
      const datosExternoContainer = document.getElementById('datos-externo-container');
      const uploadFileContainer = document.getElementById('upload-file-container');
      const cuotaSelector = document.getElementById('cuota-selector');
      const fileInputComprobante = document.getElementById('comprobante-manual-upload');
      const btnClearComprobante = document.getElementById('btn-clear-comprobante');
      const comprobanteErrorMsg = document.getElementById('comprobante-error-msg'); // (NUEVO)

      const tipoComprobanteSelect = document.getElementById('tipo-comprobante-select');
      if (tipoComprobanteSelect) {
        tipoComprobanteSelect.addEventListener('change', function() {
          const tipo = this.value;
          datosExternoContainer.style.display = (tipo !== '') ? 'block' : 'none';
          uploadFileContainer.style.display = (tipo !== '') ? 'block' : 'none';
          cuotaSelectorContainer.style.display = (tipo === 'mp_cuotas_group') ? 'block' : 'none';

          if (tipo !== 'mp_cuotas_group' && cuotaSelector) {
            cuotaSelector.value = ''; // Resetear sub-menú
          }
          if(fileInputComprobante) fileInputComprobante.value = '';
          if(document.getElementById('comprobante-manual-name')) document.getElementById('comprobante-manual-name').textContent = 'Ningún archivo seleccionado';
          if(btnClearComprobante) btnClearComprobante.style.display = 'none';
          if(comprobanteErrorMsg) comprobanteErrorMsg.textContent = ''; // Limpiar error
        });
      }

      if (fileInputComprobante) {
        fileInputComprobante.addEventListener('change', function() {
          const file = this.files[0];
          document.getElementById('comprobante-manual-name').textContent = file ? file.name : 'Ningún archivo seleccionado';
          btnClearComprobante.style.display = file ? 'inline-block' : 'none';
          if(comprobanteErrorMsg) comprobanteErrorMsg.textContent = ''; // Limpiar error
        });
      }

      if (btnClearComprobante) {
        btnClearComprobante.addEventListener('click', function() {
          fileInputComprobante.value = '';
          document.getElementById('comprobante-manual-name').textContent = 'Ningún archivo seleccionado';
          this.style.display = 'none';
        });
      }

      const btnSubmitComprobante = document.getElementById('btn-submit-comprobante-manual');
      if (btnSubmitComprobante) {
        btnSubmitComprobante.addEventListener('click', function() {
          comprobanteErrorMsg.textContent = ''; // Limpiar error
          const file = fileInputComprobante.files[0];
          const tipoComprobanteSelect = document.getElementById('tipo-comprobante-select');
          let tipoComprobante = tipoComprobanteSelect.value;

          if (tipoComprobante === 'mp_cuotas_group') {
            const cuotaSelector = document.getElementById('cuota-selector');
            if (!cuotaSelector.value) {
              // (MODIFICADO) Error inline
              comprobanteErrorMsg.textContent = 'Por favor, seleccione la Cuota (b.1, b.2, b.3 o b.4) a la que corresponde el comprobante.';
              return;
            }
            tipoComprobante = cuotaSelector.value;
          }

          let datosExtras = null;

          if (tipoComprobante && tipoComprobante !== 'mp_cuotas_group') {
            const nombrePagador = document.getElementById('externo-nombre-pagador').value;
            const dniPagadorInput = document.getElementById('externo-dni-pagador');
            const dniPagador = dniPagadorInput.value;

            if (!nombrePagador || !dniPagador) {
              comprobanteErrorMsg.textContent = 'Por favor, complete el Nombre/Apellido y DNI del Adulto Pagador.';
              return;
            }
            if (!/^[0-9]{8}$/.test(dniPagador)) {
              comprobanteErrorMsg.textContent = 'Error: El DNI del Adulto Pagador debe tener exactamente 8 dígitos numéricos.';
              dniPagadorInput.focus();
              return;
            }
            datosExtras = { nombrePagador: nombrePagador, dniPagador: dniPagador };
          }

          const dni = document.getElementById('dni-input').value;
          if (!file) {
            comprobanteErrorMsg.textContent = 'Por favor, seleccione un archivo para subir.'; // (MODIFICADO) Error inline
            return;
          }
          if (!tipoComprobante || tipoComprobante === 'mp_cuotas_group') {
            comprobanteErrorMsg.textContent = 'Por favor, seleccione el tipo de comprobante (Total, Cuota o Externo).'; // (MODIFICADO) Error inline
            return;
          }

          this.disabled = true;
          fileInputComprobante.disabled = true;
          // if(document.getElementById('btn-pagar-pendiente')) ... // Botón MP eliminado
          if(document.getElementById('btn-finalizar-upload')) document.getElementById('btn-finalizar-upload').disabled = true;

          const loader = document.getElementById('loader-validacion'); // (NUEVO)
          loader.style.display = 'block';
          loader.querySelector('p').textContent = "Subiendo comprobante...";
          loader.scrollIntoView({ behavior: 'smooth', block: 'center' }); // (NUEVO) Scroll a loader

          comprimirYLeerArchivo(file).then(fileData => {
            google.script.run
            .withSuccessHandler(handleComprobanteUploadSuccess)
            .withFailureHandler(handleComprobanteUploadFailure)
            .subirComprobanteManual(dni, fileData, tipoComprobante, datosExtras);
          }).catch(err => {
            handleComprobanteUploadFailure(err);
          });
        });
      }

      // (MODIFICADO) Botón de pagar MP eliminado
      // const btnPagar = document.getElementById('btn-pagar-pendiente');

    }

    // --- (NUEVO) Listeners para Edición ---
    document.getElementById('btn-editar-info').addEventListener('click', function() {
      // Poblar el formulario de edición
      cargarDatosParaEdicion(GLOBAL_EDIT_DATA);
      document.getElementById('editar-info-seccion').style.display = 'block';
      this.style.display = 'none'; // Ocultar botón "Editar"
    });

    document.getElementById('btn-cancelar-edicion').addEventListener('click', function() {
      document.getElementById('editar-info-seccion').style.display = 'none';
      document.getElementById('btn-editar-info').style.display = 'block'; // Mostrar botón "Editar"
    });

    document.getElementById('btn-add-autorizado-edit').addEventListener('click', function() {
      addAutorizadoCampos('', '', 'autorizados-container-edit'); // Llama a la versión modificada
    });

    document.getElementById('edit-certificadoAptitud').addEventListener('change', function() {
      manejarSubidaArchivo(this, 'ficha', 'edit-certificadoAptitudName', 'loader-certificado-edit', 'urlCertificadoAptitud-edit');
    });

    document.getElementById('btn-guardar-edicion').addEventListener('click', function() {
      const btn = this;
      const loader = document.getElementById('loader-validacion');
      const errorMsgDiv = document.getElementById('edicion-error-msg');
      const successMsgDiv = document.getElementById('edicion-success-msg');

      errorMsgDiv.textContent = '';
      successMsgDiv.style.display = 'none';

      // Recolectar datos
      const datosEditados = {};
      datosEditados.adultoResponsable1 = document.getElementById('edit-adultoResponsable1').value;
      datosEditados.dniResponsable1 = document.getElementById('edit-dniResponsable1').value;
      const telArea1 = document.getElementById('edit-telAreaResp1').value;
      const telNum1 = document.getElementById('edit-telNumResp1').value;
      datosEditados.telResp1 = (telArea1 && telNum1) ? `(${telArea1}) ${telNum1}` : '';

      datosEditados.adultoResponsable2 = document.getElementById('edit-adultoResponsable2').value;
      const telArea2 = document.getElementById('edit-telAreaResp2').value;
      const telNum2 = document.getElementById('edit-telNumResp2').value;
      datosEditados.telResp2 = (telArea2 && telNum2) ? `(${telArea2}) ${telNum2}` : '';

      datosEditados.urlCertificadoAptitud = document.getElementById('urlCertificadoAptitud-edit').value;

      // Recolectar autorizados
      const nombresAut = document.querySelectorAll('#autorizados-container-edit .autorizado-nombre');
      const dnisAut = document.querySelectorAll('#autorizados-container-edit .autorizado-dni');
      let autorizadosValidos = 0;
      let autorizadosArray = [];

      if (nombresAut.length === 0) {
        errorMsgDiv.textContent = 'Error: Debe agregar al menos una persona autorizada.';
        return;
      }

      for (let i = 0; i < nombresAut.length; i++) {
        const nombre = nombresAut[i].value.trim();
        const dni = dnisAut[i] ? dnisAut[i].value.trim() : '';

        if (nombre && dni) {
          if (!/^[0-9]{8}$/.test(dni)) {
            errorMsgDiv.textContent = 'Error: El DNI de la persona autorizada (' + nombre + ') debe tener 8 dígitos.';
            dnisAut[i].focus();
            return;
          }
          autorizadosArray.push(`${nombre} (DNI: ${dni})`);
          autorizadosValidos++;
        } else if (nombre || dni) {
          errorMsgDiv.textContent = 'Error: Complete Nombre y DNI de la persona autorizada.';
          (nombre ? dnisAut[i] : nombresAut[i]).focus();
          return;
        }
      }

      if (autorizadosValidos === 0) {
        errorMsgDiv.textContent = 'Error: Debe ingresar al menos una persona autorizada (Nombre y DNI).';
        return;
      }
      datosEditados.personasAutorizadas = autorizadosArray.join(', ');

      // Deshabilitar botón y mostrar loader
      btn.disabled = true;
      loader.style.display = 'block';
      loader.querySelector('p').textContent = "Guardando cambios...";
      loader.scrollIntoView({ behavior: 'smooth', block: 'center' });

      const dni = document.getElementById('dni-input').value;

      google.script.run
      .withSuccessHandler(function(response) {
        loader.style.display = 'none';
        btn.disabled = false;
        if (response.status === 'OK') {
          successMsgDiv.textContent = response.message;
          successMsgDiv.style.display = 'block';
          // Actualizar datos globales por si edita de nuevo
          GLOBAL_EDIT_DATA.personasAutorizadas = datosEditados.personasAutorizadas;
          if(datosEditados.urlCertificadoAptitud) {
            GLOBAL_EDIT_DATA.urlCertificadoAptitud = datosEditados.urlCertificadoAptitud;
          }
          // (NUEVO) Actualizar datos de responsables en GLOBAL_EDIT_DATA
          GLOBAL_EDIT_DATA.adultoResponsable1 = datosEditados.adultoResponsable1;
          GLOBAL_EDIT_DATA.dniResponsable1 = datosEditados.dniResponsable1;
          GLOBAL_EDIT_DATA.telResponsable1 = datosEditados.telResp1;
          GLOBAL_EDIT_DATA.adultoResponsable2 = datosEditados.adultoResponsable2;
          GLOBAL_EDIT_DATA.telResponsable2 = datosEditados.telResp2;

        } else {
          errorMsgDiv.textContent = response.message;
        }
      })
      .withFailureHandler(function(error) {
        loader.style.display = 'none';
        btn.disabled = false;
        errorMsgDiv.textContent = 'Error de conexión: ' + error.message;
      })
      .actualizarDatosPersonales(dni, datosEditados);
    });

    // --- Fin Listeners Edición ---

    const btnFinalizar = document.getElementById('btn-finalizar-upload');
    if (btnFinalizar) {
      btnFinalizar.addEventListener('click', function() {
        window.top.location.href = APP_URL;
      });
    }

  } else { // Errores y otros avisos
    statusDiv.innerHTML = `<div class="mensaje error"><strong>Aviso:</strong> ${response.message}</div>`;
  }
}

/**
 * Handler para fallo de PASO 1 (Validación)
 */
function handleValidationFailure(error) {
  document.getElementById('btn-validar').disabled = false;
  document.getElementById('loader-validacion').style.display = 'none';
  const statusDiv = document.getElementById('status-validacion');
  statusDiv.innerHTML = `<div class="mensaje error"><strong>Error en el Servidor:</strong> ${error.message}</div>`;
}

function submitAptitudManual() {
  const fileInput = document.getElementById('aptitud-manual-upload');
  const file = fileInput.files[0];
  const dni = document.getElementById('dni-input').value;
  const errorMsgDiv = document.getElementById('aptitud-error-msg'); // (NUEVO)
  errorMsgDiv.textContent = ''; // Limpiar

  if (!file) {
    errorMsgDiv.textContent = 'Por favor, seleccione un archivo de aptitud física.'; // (MODIFICADO) Error inline
    return;
  }

  const btn = document.getElementById('btn-submit-aptitud-manual');
  const loader = document.getElementById('loader-aptitud');
  btn.disabled = true;
  loader.style.display = 'block';
  loader.scrollIntoView({ behavior: 'smooth', block: 'center' }); // (NUEVO) Scroll a loader

  comprimirYLeerArchivo(file).then(fileData => {
    google.script.run
    .withSuccessHandler(function(response) {
      loader.style.display = 'none';
      if (response.status === 'OK') {
        document.getElementById('aptitud-manual-seccion').innerHTML = `<div class="mensaje exito">${response.message}</div>`;
      } else {
        errorMsgDiv.textContent = "Error al subir: " + response.message;
        btn.disabled = false;
      }
    })
    .withFailureHandler(function(error) {
      loader.style.display = 'none';
      errorMsgDiv.textContent = "Error de conexión: " + error.message;
      btn.disabled = false;
    })
    .subirAptitudManual(dni, fileData);
  }).catch(err => {
    loader.style.display = 'none';
    errorMsgDiv.textContent = "Error al procesar archivo: " + err.message;
    btn.disabled = false;
  });
}

function handleComprobanteUploadFailure(error) {
  document.getElementById('loader-validacion').style.display = 'none';
  const statusDiv = document.getElementById('status-validacion');
  statusDiv.insertAdjacentHTML('afterbegin', `<div class="mensaje error" style="margin-bottom:10px;">Error al subir: ${error.message}</div>`);

  const fileInputComprobante = document.getElementById('comprobante-manual-upload');
  const btnSubmitComprobante = document.getElementById('btn-submit-comprobante-manual');
  const btnFinalizar = document.getElementById('btn-finalizar-upload');
  // const btnPagarPendiente = document.getElementById('btn-pagar-pendiente'); // Eliminado

  if (btnSubmitComprobante) btnSubmitComprobante.disabled = false;
  if (fileInputComprobante) fileInputComprobante.disabled = false;
  // if (btnPagarPendiente) btnPagarPendiente.disabled = false; // Eliminado
  if (btnFinalizar) btnFinalizar.disabled = false;
}

function handleComprobanteUploadSuccess(response) {
  document.getElementById('loader-validacion').style.display = 'none';
  const statusDiv = document.getElementById('status-validacion');
  const fileInputComprobante = document.getElementById('comprobante-manual-upload');
  const btnSubmitComprobante = document.getElementById('btn-submit-comprobante-manual');
  const btnFinalizar = document.getElementById('btn-finalizar-upload');
  // const btnPagarPendiente = document.getElementById('btn-pagar-pendiente'); // Eliminado

  const tipoComprobanteSelect = document.getElementById('tipo-comprobante-select');
  const cuotaSelectorContainer = document.getElementById('cuota-selector-container');
  const datosExternoContainer = document.getElementById('datos-externo-container');
  const uploadFileContainer = document.getElementById('upload-file-container');
  const btnClearComprobante = document.getElementById('btn-clear-comprobante');

  if (response.status === 'OK') {
    const successMsgHtml = `<div class="mensaje exito" style="margin-bottom:10px;">${response.message} (Puede subir otro si es necesario)</div>`;
    statusDiv.insertAdjacentHTML('afterbegin', successMsgHtml);

    if(fileInputComprobante) fileInputComprobante.value = '';
    if(document.getElementById('comprobante-manual-name')) document.getElementById('comprobante-manual-name').textContent = 'Ningún archivo seleccionado';
    if(tipoComprobanteSelect) tipoComprobanteSelect.value = '';

    if (cuotaSelectorContainer) cuotaSelectorContainer.style.display = 'none';
    if (datosExternoContainer) datosExternoContainer.style.display = 'none';
    if (uploadFileContainer) uploadFileContainer.style.display = 'none';
    if (btnClearComprobante) btnClearComprobante.style.display = 'none';

    if (document.getElementById('externo-nombre-pagador')) document.getElementById('externo-nombre-pagador').value = '';
    if (document.getElementById('externo-dni-pagador')) document.getElementById('externo-dni-pagador').value = '';

  } else {
    statusDiv.insertAdjacentHTML('afterbegin', `<div class="mensaje error" style="margin-bottom:10px;">${response.message}</div>`);
  }

  if(btnSubmitComprobante) btnSubmitComprobante.disabled = false;
  if(fileInputComprobante) fileInputComprobante.disabled = false;
  // if(btnPagarPendiente) btnPagarPendiente.disabled = false; // Eliminado
  if(btnFinalizar) btnFinalizar.disabled = false;
}

function iniciarTemporizador(response) {
  document.getElementById('timer-seccion').style.display = 'block';
  document.getElementById('btn-validar').disabled = true;
  let segundos = 8;
  const countdown = document.getElementById('timer-countdown');
  countdown.textContent = segundos;
  const interval = setInterval(() => {
    segundos--;
    countdown.textContent = segundos;
    if (segundos <= 0) {
      clearInterval(interval);
      mostrarFormulario(response);
    }
  }, 800);
}

function mostrarFormulario(response) {
  document.getElementById('validacion-seccion').style.display = 'none';
  document.getElementById('registro-seccion').style.display = 'block';

  const esPreventa = response.datos && response.datos.esPreventa === true;

  document.getElementById('dni').value = response.datos.dni;

  if (response.datos) {
    document.getElementById('email').value = response.datos.email || '';
  }

  if (response.datos) {
    document.getElementById('nombre').value = response.datos.nombre || '';
    document.getElementById('apellido').value = response.datos.apellido || '';
    document.getElementById('fechaNacimiento').value = response.datos.fechaNacimiento || '';
    document.getElementById('obraSocial').value = response.datos.obraSocial || '';
    document.getElementById('colegioJardin').value = response.datos.colegioJardin || '';
    document.getElementById('adultoResponsable1').value = response.datos.adultoResponsable1 || '';
    document.getElementById('dniResponsable1').value = response.datos.dniResponsable1 || '';

    if (response.datos.telResponsable1) {
      const telMatch = String(response.datos.telResponsable1).match(/\(?(\d{2,5})\)?\s?(\d+)/);
      if (telMatch) {
        document.getElementById('telAreaResp1').value = telMatch[1] || '';
        document.getElementById('telNumResp1').value = telMatch[2] || '';
      }
    }

    document.getElementById('adultoResponsable2').value = response.datos.adultoResponsable2 || '';
    if (response.datos.telResponsable2) {
      const telMatch2 = String(response.datos.telResponsable2).match(/\(?(\d{2,5})\)?\s?(\d+)/);
      if (telMatch2) {
        document.getElementById('telAreaResp2').value = telMatch[1] || '';
        document.getElementById('telNumResp2').value = telMatch[2] || '';
      }
    }

    if (response.datos.personasAutorizadas) {
      const autorizados = response.datos.personasAutorizadas.split(',');
      const container = document.getElementById('autorizados-container');

      container.innerHTML = '';

      autorizados.forEach(aut => {
        const autTrim = aut.trim();
        if (autTrim) {
          const match = autTrim.match(/(.*)\(DNI:\s?(\d+)\)/);
          if (match) {
            addAutorizadoCampos(match[1].trim(), match[2].trim());
          } else {
            addAutorizadoCampos(autTrim, '');
          }
        }
      });
    }

    if (esPreventa) {
      document.getElementById('jornada').value = response.datos.jornada || '';
    }
  }

  if (response.jornadaExtendidaAlcanzada === true) {
    const opcionExtendida = document.getElementById('opcion-jornada-extendida');
    if (opcionExtendida) {
      opcionExtendida.disabled = true;
      opcionExtendida.textContent = "Jornada Extendida (SIN CUPO)";
    }
    const msgCupo = document.getElementById('jornada-cupo-msg');
    if (msgCupo) {
      msgCupo.style.display = 'inline';
    }
  }

  // (MODIFICADO) Lógica de pago total MP eliminada
  // const opcionPagoTotal = document.querySelector('#metodoPago option[value="Pago 1 Cuota Deb/Cred MP(Total)"]');
  // ...

  if (esPreventa) {
    const inputsParaBloquear = ['nombre', 'apellido', 'fechaNacimiento', 'email'];
    inputsParaBloquear.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.readOnly = true;
        el.classList.add('campo-bloqueado');
        el.classList.add('form-cache');
      }
    });

    const jornadaSelect = document.getElementById('jornada');
    if (jornadaSelect) {
      jornadaSelect.classList.add('form-cache');
    }

    document.getElementById('dni').classList.add('campo-bloqueado');
    document.getElementById('dni').classList.add('form-cache');
  }

  if (document.querySelectorAll('#autorizados-container .autorizado-nombre').length === 0) {
    addAutorizadoCampos();
  }

  guardarFormEnCache();
  calcularYMostrarEdad();

  document.getElementById('fechaNacimiento').addEventListener('input', calcularYMostrarEdad);

  toggleEspecifique('practicaDeporte', 'especifiqueDeporte');
  toggleEspecifique('tieneEnfermedad', 'especifiqueEnfermedad');
  toggleEspecifique('esAlergico', 'especifiqueAlergia');

  toggleCantidadCuotas();
  toggleTransferenciaInfo();
  toggleCuotasInfo();
}

function comprimirYLeerArchivo(file) {
  const MAX_WIDTH = 1024;
  const QUALITY = 0.7;
  const mimeType = file.type;

  return new Promise((resolve, reject) => {
    if (mimeType !== 'image/jpeg' && mimeType !== 'image/png') {
      readFileAsBase64(file).then(data => {
        resolve({ data, mimeType, fileName: file.name });
      }).catch(reject);
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        let width = img.width;
        let height = img.height;
        if (width > height) {
          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }
        } else {
          if (height > MAX_WIDTH) {
            width *= MAX_WIDTH / height;
            height = MAX_WIDTH;
          }
        }
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        const compressedData = canvas.toDataURL('image/jpeg', QUALITY);
        resolve({
          data: compressedData,
          mimeType: 'image/jpeg',
          fileName: file.name.replace(/\.[^/.]+$/, "") + ".jpg"
        });
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function manejarSubidaArchivo(inputElement, tipoArchivo, nombreLabelId, loaderId, urlHiddenId) {
  const file = inputElement.files[0];
  const nombreLabel = document.getElementById(nombreLabelId);
  const loader = document.getElementById(loaderId);
  const urlHidden = document.getElementById(urlHiddenId);
  // (MODIFICADO) DNI se toma del input de validación por si falla el del form
  const dni = document.getElementById('dni-input').value || document.getElementById('dni').value;

  urlHidden.value = '';
  loader.style.display = 'none';
  nombreLabel.textContent = 'Ningún archivo seleccionado';
  if (!file) return;

  if (!dni) {
    alert("Error: No se puede subir un archivo si el DNI no está cargado. Por favor, valide su DNI en el Paso 1.");
    inputElement.value = '';
    return;
  }

  nombreLabel.textContent = file.name;
  loader.className = 'loader-archivo';
  loader.style.display = 'block';
  loader.textContent = 'Iniciando...';

  inputElement.disabled = true;
  if(document.getElementById('submit-button')) document.getElementById('submit-button').disabled = true;
  if(document.getElementById('btn-guardar-edicion')) document.getElementById('btn-guardar-edicion').disabled = true;


  loader.textContent = 'Preparando archivo (comprimiendo si es imagen)...';
  comprimirYLeerArchivo(file).then(fileData => {
    loader.textContent = 'Subiendo archivo...';
    google.script.run
    .withSuccessHandler(function(response) {
      inputElement.disabled = false;
      if(document.getElementById('submit-button')) document.getElementById('submit-button').disabled = false;
      if(document.getElementById('btn-guardar-edicion')) document.getElementById('btn-guardar-edicion').disabled = false;

      if (response.status === 'OK') {
        loader.className = 'loader-archivo exito';
        loader.textContent =   '✅ Archivo subido con éxito.'  ;
        urlHidden.value = response.url;
      } else {
        loader.className = 'loader-archivo error';
        loader.textContent =   `❌ Error:   ${response.message}`;
        inputElement.value = '';
        nombreLabel.textContent = 'Ningún archivo seleccionado';
      }
    })
    .withFailureHandler(function(error) {
      inputElement.disabled = false;
      if(document.getElementById('submit-button')) document.getElementById('submit-button').disabled = false;
      if(document.getElementById('btn-guardar-edicion')) document.getElementById('btn-guardar-edicion').disabled = false;
      loader.className = 'loader-archivo error';
      loader.textContent =   `❌ Error de conexión:   ${error.message}`;
      inputElement.value = '';
      nombreLabel.textContent = 'Ningún archivo seleccionado';
    })
    .subirArchivoIndividual(fileData, dni, tipoArchivo);
  }).catch(err => {
    inputElement.disabled = false;
    if(document.getElementById('submit-button')) document.getElementById('submit-button').disabled = false;
    if(document.getElementById('btn-guardar-edicion')) document.getElementById('btn-guardar-edicion').disabled = false;
    loader.className = 'loader-archivo error';
    loader.textContent =   `❌ Error al procesar el archivo:   ${err.message}`;
    inputElement.value = '';
    nombreLabel.textContent = 'Ningún archivo seleccionado';
  });
}

function calcularYMostrarEdad(fechaNacimientoStr, divId) {
  let fechaNac = fechaNacimientoStr;
  let divEdad = divId;

  if (!fechaNacimientoStr || (fechaNacimientoStr && typeof fechaNacimientoStr === 'object')) {
    fechaNac = document.getElementById('fechaNacimiento').value;
    divEdad = document.getElementById('edad-calculada');
  }

  if (!fechaNac) {
    if (divEdad) divEdad.textContent = '';
    return;
  }

  const fechaNacimiento = new Date(fechaNac);
  const hoy = new Date();
  fechaNacimiento.setMinutes(fechaNacimiento.getMinutes() + fechaNacimiento.getTimezoneOffset());
  let anos = hoy.getFullYear() - fechaNacimiento.getFullYear();
  let meses = hoy.getMonth() - fechaNacimiento.getMonth();
  let dias = hoy.getDate() - fechaNacimiento.getDate();
  if (dias < 0) {
    meses--;
    dias += new Date(hoy.getFullYear(), hoy.getMonth(), 0).getDate();
  }
  if (meses < 0) {
    anos--;
    meses += 12;
  }
  if (anos >= 0) {
    if (divEdad) divEdad.textContent = `Edad actual: ${anos} años, ${meses} meses y ${dias} días.`;
  } else {
    if (divEdad) divEdad.textContent = '';
  }
}

function toggleEspecifique(radioName, inputId) {
  const radioChecked = document.querySelector(`input[name="${radioName}"]:checked`);
  const inputField = document.getElementById(inputId);
  if (radioChecked && radioChecked.value === 'Sí') {
    inputField.style.display = 'block';
    inputField.required = true;
  } else {
    inputField.style.display = 'none';
    inputField.value = '';
    inputField.required = false;
  }
}

function toggleCantidadCuotas() {
  const metodoPago = document.getElementById('metodoPago').value;
  const container = document.getElementById('cantidadCuotasContainer');
  if (!container) return;

  const selectCuotas = document.getElementById('cantidadCuotas');
  if (metodoPago === 'Pago en Cuotas') {
    container.style.display = 'block';
    selectCuotas.classList.add('form-cache');
    selectCuotas.required = true;
  } else {
    container.style.display = 'none';
    selectCuotas.classList.remove('form-cache');
    selectCuotas.required = false;
    selectCuotas.value = '';
  }
}

function toggleCuotasInfo() {
  const metodoPago = document.getElementById('metodoPago').value;
  const show = (metodoPago === 'Pago en Cuotas');

  const containerAlias = document.getElementById('cuotas-transferencia-info');
  if(containerAlias) containerAlias.style.display = show ? 'block' : 'none';
}

function toggleTransferenciaInfo() {
  const metodoPago = document.getElementById('metodoPago').value;
  const container = document.getElementById('transferencia-info');
  container.style.display = (metodoPago === 'Transferencia') ? 'block' : 'none';
}

function removerFila(boton) {
  boton.parentElement.remove();
  guardarFormEnCache();
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = (error) => reject(error);
    reader.readAsDataURL(file);
  });
}

/**
 * (MODIFICADO)
 * Añadido 'containerId' para reutilizar la función en el formulario de edición.
 */
function addAutorizadoCampos(nombre = '', dni = '', containerId = 'autorizados-container') {
  const container = document.getElementById(containerId);
  const div = document.createElement('div');
  div.className = 'fila-dinamica';

  // (MODIFICADO) class 'form-cache' solo se aplica al formulario principal
  const cacheClass = (containerId === 'autorizados-container') ? 'form-cache' : '';
  const isRequired = (container.children.length === 0) ? 'required' : '';

  div.innerHTML = `
  <div class="campos-dinamicos">
  <input type="text" class="autorizado-nombre ${cacheClass}" placeholder="Nombre y Apellido (Relación)" value="${nombre}" ${isRequired}>
  <input type="tel" class="autorizado-dni ${cacheClass}" placeholder="DNI (8 dígitos)" maxlength="8" pattern="[0-9]{8}" inputmode="numeric" value="${dni}" ${isRequired} title="El DNI debe tener exactamente 8 dígitos numéricos.">
  </div>
  <button type="button" class="btn-remover" onclick="removerFila(this)">X</button>
  `;
  container.appendChild(div);
}

/**
 * (NUEVO)
 * Puebla el formulario de edición con los datos del usuario.
 */
function cargarDatosParaEdicion(datos) {
  if (!datos) return;

  document.getElementById('edit-email').value = datos.email || '';
  document.getElementById('edit-adultoResponsable1').value = datos.adultoResponsable1 || '';
  document.getElementById('edit-dniResponsable1').value = datos.dniResponsable1 || '';

  if (datos.telResponsable1) {
    const telMatch = String(datos.telResponsable1).match(/\(?(\d{2,5})\)?\s?(\d+)/);
    if (telMatch) {
      document.getElementById('edit-telAreaResp1').value = telMatch[1] || '';
      document.getElementById('edit-telNumResp1').value = telMatch[2] || '';
    }
  } else {
    document.getElementById('edit-telAreaResp1').value = '';
    document.getElementById('edit-telNumResp1').value = '';
  }

  document.getElementById('edit-adultoResponsable2').value = datos.adultoResponsable2 || '';
  if (datos.telResponsable2) {
    const telMatch2 = String(datos.telResponsable2).match(/\(?(\d{2,5})\)?\s?(\d+)/);
    if (telMatch2) {
      document.getElementById('edit-telAreaResp2').value = telMatch2[1] || '';
      document.getElementById('edit-telNumResp2').value = telMatch2[2] || '';
    }
  } else {
    document.getElementById('edit-telAreaResp2').value = '';
    document.getElementById('edit-telNumResp2').value = '';
  }

  // Poblar autorizados
  const container = document.getElementById('autorizados-container-edit');
  container.innerHTML = ''; // Limpiar
  if (datos.personasAutorizadas) {
    const autorizados = datos.personasAutorizadas.split(',');
    autorizados.forEach(aut => {
      const autTrim = aut.trim();
      if (autTrim) {
        const match = autTrim.match(/(.*)\(DNI:\s?(\d+)\)/);
        if (match) {
          addAutorizadoCampos(match[1].trim(), match[2].trim(), 'autorizados-container-edit');
        } else {
          addAutorizadoCampos(autTrim, '', 'autorizados-container-edit');
        }
      }
    });
  }
  // Añadir uno vacío si no hay ninguno
  if (container.children.length === 0) {
    addAutorizadoCampos('', '', 'autorizados-container-edit');
  }

  // Limpiar campos de subida de archivos
  document.getElementById('edit-certificadoAptitudName').textContent = 'Ningún archivo seleccionado';
  document.getElementById('loader-certificado-edit').style.display = 'none';
  document.getElementById('urlCertificadoAptitud-edit').value = '';
  document.getElementById('edicion-error-msg').textContent = '';
  document.getElementById('edicion-success-msg').style.display = 'none';
}


function addHermanoCampos() {
  const container = document.getElementById('hermanos-container');
  const div = document.createElement('div');
  div.className = 'fila-dinamica';
  const uniqueId = 'hermano_edad_' + container.children.length;

  div.innerHTML = `
  <div class="hermano-campos">
  <input type="text" class="hermano-nombre form-cache" placeholder="Nombre Hermano/a" required>
  <input type="text" class="hermano-apellido form-cache" placeholder="Apellido Hermano/a" required>

  <input type="tel" class="hermano-dni form-cache" placeholder="DNI Hermano/a (8 dígitos)" maxlength="8" pattern="[0-9]{8}" inputmode="numeric" required title="El DNI debe tener exactamente 8 dígitos numéricos.">
  <input type="date" class="hermano-fechanac form-cache" required oninput="calcularYMostrarEdad(this.value, '${uniqueId}')" min="2010-01-01" max="2023-12-31">

  <div class="hermano-dni-error" style="color: red; font-size: 0.85em; grid-column: 1 / 2; margin-top: -10px; min-height: 1.2em;"></div>
  <div class="hermano-fecha-error" style="color: red; font-size: 0.85em; grid-column: 2 / 3; margin-top: -10px; min-height: 1.2em;"></div>

  <div id="${uniqueId}" class="edad-calculada" style="grid-column: 1 / -1; font-size: 0.9em; margin-top: 5px; margin-left: 5px;"></div>
  </div>
  <button type="button" class="btn-remover" onclick="removerFila(this)">X</button>
  `;
  container.appendChild(div);
}

function guardarFormEnCache() {
  try {
    const data = {};
    document.querySelectorAll('.form-cache').forEach(el => {
      const key = el.id || el.name;
      if (!key) return;

      if (el.disabled) {
        return;
      }

      if (el.readOnly) {
        data[key] = el.value;
        return;
      }

      if (el.type === 'radio') {
        if (el.checked) {
          data[el.name] = el.value;
        }
      } else {
        data[key] = el.value;
      }
    });

    data.autorizados = [];
    const nombresAut = document.querySelectorAll('#autorizados-container .autorizado-nombre'); // Target principal
    const dnisAut = document.querySelectorAll('#autorizados-container .autorizado-dni'); // Target principal
    for (let i = 0; i < dnisAut.length; i++) {
      if (nombresAut[i].value || dnisAut[i].value) {
        data.autorizados.push({ n: nombresAut[i].value, d: dnisAut[i].value });
      }
    }

    data.hermanos = [];
    const nombresHermano = document.querySelectorAll('.hermano-nombre');
    const apellidosHermano = document.querySelectorAll('.hermano-apellido');
    const dnisHermano = document.querySelectorAll('.hermano-dni');
    const fechasNacHermano = document.querySelectorAll('.hermano-fechanac');
    for (let i = 0; i < dnisHermano.length; i++) {
      if (nombresHermano[i].value || dnisHermano[i].value) {
        data.hermanos.push({
          n: nombresHermano[i].value,
          a: apellidosHermano[i].value,
          d: dnisHermano[i].value,
          f: fechasNacHermano[i].value
        });
      }
    }

    localStorage.setItem(CACHE_KEY, JSON.stringify(data));

  } catch (e) {
    console.warn("No se pudo guardar el caché del formulario: ", e);
  }
}

function cargarFormDesdeCache() {
  try {
    const data = JSON.parse(localStorage.getItem(CACHE_KEY));
    if (!data) return;

    document.querySelectorAll('.form-cache').forEach(el => {
      const key = el.id || el.name;
      if (!key) return;

      if (data[key] !== undefined) {
        if (el.type === 'radio') {
          el.checked = (el.value === data[key]);
        } else {
          el.value = data[key];
        }
      }
    });

    if (data.autorizados && data.autorizados.length > 0) {
      const autContainer = document.getElementById('autorizados-container');
      autContainer.innerHTML = '';
      data.autorizados.forEach(aut => {
        addAutorizadoCampos(aut.n || '', aut.d || '');
      });
    }

    if (data.hermanos && data.hermanos.length > 0) {
      const hermContainer = document.getElementById('hermanos-container');
      hermContainer.innerHTML = '';
      data.hermanos.forEach(herm => {
        addHermanoCampos();
        hermContainer.querySelector('.hermano-nombre:last-of-type').value = herm.n || '';
        hermContainer.querySelector('.hermano-apellido:last-of-type').value = herm.a || '';
        hermContainer.querySelector('.hermano-dni:last-of-type').value = herm.d || '';
        const fechaInput = hermContainer.querySelector('.hermano-fechanac:last-of-type');
        fechaInput.value = herm.f || '';

        const onInputAttr = fechaInput.getAttribute('oninput');
        if (onInputAttr) {
          const edadDivIdMatch = onInputAttr.match(/'(hermano_edad_\d+)'/);
          if (edadDivIdMatch && edadDivIdMatch[1]) {
            const edadDivId = edadDivIdMatch[1];
            calcularYMostrarEdad(herm.f, document.getElementById(edadDivId));
          }
        }
      });
    }

    calcularYMostrarEdad();

    toggleTransferenciaInfo();
    toggleCuotasInfo(); // Añadido para restaurar estado

  } catch (e) {
    console.warn("No se pudo cargar el caché del formulario: ", e);
  }
}

function limpiarCache() {
  localStorage.removeItem(CACHE_KEY);
}

document.addEventListener('DOMContentLoaded', () => {

  const autoDNI = localStorage.getItem('autoValidateDNI');
  const autoType = localStorage.getItem('autoValidateType');

  if (autoDNI && autoType) {
    localStorage.removeItem('autoValidateDNI');
    localStorage.removeItem('autoValidateType');

    document.getElementById('dni-input').value = autoDNI;
    document.getElementById('tipoInscripto').value = autoType;

    setTimeout(() => {
      document.getElementById('btn-validar').click();
    }, 100);
  }


  if (document.querySelectorAll('#autorizados-container .autorizado-nombre').length === 0) {
    addAutorizadoCampos();
  }

  cargarFormDesdeCache();
  toggleEspecifique('practicaDeporte', 'especifiqueDeporte');
  toggleEspecifique('tieneEnfermedad', 'especifiqueEnfermedad');
  toggleEspecifique('esAlergico', 'especifiqueAlergia');

  toggleTransferenciaInfo();
  toggleCuotasInfo(); 

  document.getElementById('fechaNacimiento').addEventListener('input', calcularYMostrarEdad);

}); 
</script>